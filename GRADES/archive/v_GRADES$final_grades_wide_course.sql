USE KIPP_NJ
GO

ALTER VIEW GRADES$final_grades_wide_course AS

WITH course_unpivot AS (
  SELECT student_number
        ,academic_year
        ,term      
        ,CONCAT('rc', RIGHT(CONCAT('0',class_rn),2), '_', field) AS pivot_field
        ,CONVERT(VARCHAR(64),CASE WHEN value = '' THEN NULL ELSE value END) AS value
  FROM KIPP_NJ..GRADES$final_grades_wide#static WITH(NOLOCK)    
  UNPIVOT(
    value
    FOR field IN (course_name
                 ,teacher_name
                 ,credit_hours
                 ,RT1_term_grade_letter
                 ,RT1_term_grade_letter_adjusted
                 ,RT1_term_grade_percent
                 ,RT1_term_grade_percent_adjusted                 
                 ,RT2_term_grade_letter
                 ,RT2_term_grade_letter_adjusted
                 ,RT2_term_grade_percent
                 ,RT2_term_grade_percent_adjusted                 
                 ,RT3_term_grade_letter
                 ,RT3_term_grade_letter_adjusted
                 ,RT3_term_grade_percent
                 ,RT3_term_grade_percent_adjusted                 
                 ,RT4_term_grade_letter
                 ,RT4_term_grade_letter_adjusted
                 ,RT4_term_grade_percent
                 ,RT4_term_grade_percent_adjusted                 
                 ,CUR_term_grade_letter
                 ,CUR_term_grade_letter_adjusted
                 ,CUR_term_grade_percent
                 ,CUR_term_grade_percent_adjusted                 
                 ,e1_grade_percent
                 ,e2_grade_percent
                 ,y1_grade_letter
                 ,y1_grade_percent)
   ) u
  WHERE course_number NOT IN ('ALL','HR')
 )

SELECT *
FROM course_unpivot
PIVOT(
  MAX(value)
  FOR pivot_field IN ([rc01_course_name]
                     ,[rc01_credit_hours]
                     ,[rc01_e1_grade_percent]
                     ,[rc01_e2_grade_percent]
                     ,[rc01_RT1_term_grade_letter]
                     ,[rc01_RT1_term_grade_letter_adjusted]
                     ,[rc01_RT1_term_grade_percent]
                     ,[rc01_RT1_term_grade_percent_adjusted]                     
                     ,[rc01_RT2_term_grade_letter]
                     ,[rc01_RT2_term_grade_letter_adjusted]
                     ,[rc01_RT2_term_grade_percent]
                     ,[rc01_RT2_term_grade_percent_adjusted]                     
                     ,[rc01_RT3_term_grade_letter]
                     ,[rc01_RT3_term_grade_letter_adjusted]
                     ,[rc01_RT3_term_grade_percent]
                     ,[rc01_RT3_term_grade_percent_adjusted]                     
                     ,[rc01_RT4_term_grade_letter]
                     ,[rc01_RT4_term_grade_letter_adjusted]
                     ,[rc01_RT4_term_grade_percent]
                     ,[rc01_RT4_term_grade_percent_adjusted]                     
                     ,[rc01_CUR_term_grade_letter_adjusted]
                     ,[rc01_CUR_term_grade_percent]
                     ,[rc01_CUR_term_grade_percent_adjusted]                     
                     ,[rc01_teacher_name]
                     ,[rc01_y1_grade_letter]
                     ,[rc01_y1_grade_percent]
                     ,[rc02_course_name]
                     ,[rc02_credit_hours]
                     ,[rc02_e1_grade_percent]
                     ,[rc02_e2_grade_percent]
                     ,[rc02_RT1_term_grade_letter]
                     ,[rc02_RT1_term_grade_letter_adjusted]
                     ,[rc02_RT1_term_grade_percent]
                     ,[rc02_RT1_term_grade_percent_adjusted]                     
                     ,[rc02_RT2_term_grade_letter]
                     ,[rc02_RT2_term_grade_letter_adjusted]
                     ,[rc02_RT2_term_grade_percent]
                     ,[rc02_RT2_term_grade_percent_adjusted]                     
                     ,[rc02_RT3_term_grade_letter]
                     ,[rc02_RT3_term_grade_letter_adjusted]
                     ,[rc02_RT3_term_grade_percent]
                     ,[rc02_RT3_term_grade_percent_adjusted]                     
                     ,[rc02_RT4_term_grade_letter]
                     ,[rc02_RT4_term_grade_letter_adjusted]
                     ,[rc02_RT4_term_grade_percent]
                     ,[rc02_RT4_term_grade_percent_adjusted]
                     ,[rc02_CUR_term_grade_letter_adjusted]
                     ,[rc02_CUR_term_grade_percent]
                     ,[rc02_CUR_term_grade_percent_adjusted]                     
                     ,[rc02_teacher_name]
                     ,[rc02_y1_grade_letter]
                     ,[rc02_y1_grade_percent]
                     ,[rc03_course_name]
                     ,[rc03_credit_hours]
                     ,[rc03_e1_grade_percent]
                     ,[rc03_e2_grade_percent]
                     ,[rc03_RT1_term_grade_letter]
                     ,[rc03_RT1_term_grade_letter_adjusted]
                     ,[rc03_RT1_term_grade_percent]
                     ,[rc03_RT1_term_grade_percent_adjusted]                     
                     ,[rc03_RT2_term_grade_letter]
                     ,[rc03_RT2_term_grade_letter_adjusted]
                     ,[rc03_RT2_term_grade_percent]
                     ,[rc03_RT2_term_grade_percent_adjusted]                     
                     ,[rc03_RT3_term_grade_letter]
                     ,[rc03_RT3_term_grade_letter_adjusted]
                     ,[rc03_RT3_term_grade_percent]
                     ,[rc03_RT3_term_grade_percent_adjusted]                     
                     ,[rc03_RT4_term_grade_letter]
                     ,[rc03_RT4_term_grade_letter_adjusted]
                     ,[rc03_RT4_term_grade_percent]
                     ,[rc03_RT4_term_grade_percent_adjusted]
                     ,[rc03_CUR_term_grade_letter_adjusted]
                     ,[rc03_CUR_term_grade_percent]
                     ,[rc03_CUR_term_grade_percent_adjusted]                     
                     ,[rc03_teacher_name]
                     ,[rc03_y1_grade_letter]
                     ,[rc03_y1_grade_percent]
                     ,[rc04_course_name]
                     ,[rc04_credit_hours]
                     ,[rc04_e1_grade_percent]
                     ,[rc04_e2_grade_percent]
                     ,[rc04_RT1_term_grade_letter]
                     ,[rc04_RT1_term_grade_letter_adjusted]
                     ,[rc04_RT1_term_grade_percent]
                     ,[rc04_RT1_term_grade_percent_adjusted]                     
                     ,[rc04_RT2_term_grade_letter]
                     ,[rc04_RT2_term_grade_letter_adjusted]
                     ,[rc04_RT2_term_grade_percent]
                     ,[rc04_RT2_term_grade_percent_adjusted]                     
                     ,[rc04_RT3_term_grade_letter]
                     ,[rc04_RT3_term_grade_letter_adjusted]
                     ,[rc04_RT3_term_grade_percent]
                     ,[rc04_RT3_term_grade_percent_adjusted]                     
                     ,[rc04_RT4_term_grade_letter]
                     ,[rc04_RT4_term_grade_letter_adjusted]
                     ,[rc04_RT4_term_grade_percent]
                     ,[rc04_RT4_term_grade_percent_adjusted]
                     ,[rc04_CUR_term_grade_letter_adjusted]
                     ,[rc04_CUR_term_grade_percent]
                     ,[rc04_CUR_term_grade_percent_adjusted]                     
                     ,[rc04_teacher_name]
                     ,[rc04_y1_grade_letter]
                     ,[rc04_y1_grade_percent]
                     ,[rc05_course_name]
                     ,[rc05_credit_hours]
                     ,[rc05_e1_grade_percent]
                     ,[rc05_e2_grade_percent]
                     ,[rc05_RT1_term_grade_letter]
                     ,[rc05_RT1_term_grade_letter_adjusted]
                     ,[rc05_RT1_term_grade_percent]
                     ,[rc05_RT1_term_grade_percent_adjusted]                     
                     ,[rc05_RT2_term_grade_letter]
                     ,[rc05_RT2_term_grade_letter_adjusted]
                     ,[rc05_RT2_term_grade_percent]
                     ,[rc05_RT2_term_grade_percent_adjusted]                     
                     ,[rc05_RT3_term_grade_letter]
                     ,[rc05_RT3_term_grade_letter_adjusted]
                     ,[rc05_RT3_term_grade_percent]
                     ,[rc05_RT3_term_grade_percent_adjusted]                     
                     ,[rc05_RT4_term_grade_letter]
                     ,[rc05_RT4_term_grade_letter_adjusted]
                     ,[rc05_RT4_term_grade_percent]
                     ,[rc05_RT4_term_grade_percent_adjusted]
                     ,[rc05_CUR_term_grade_letter_adjusted]
                     ,[rc05_CUR_term_grade_percent]
                     ,[rc05_CUR_term_grade_percent_adjusted]                     
                     ,[rc05_teacher_name]
                     ,[rc05_y1_grade_letter]
                     ,[rc05_y1_grade_percent]
                     ,[rc06_course_name]
                     ,[rc06_credit_hours]
                     ,[rc06_e1_grade_percent]
                     ,[rc06_e2_grade_percent]
                     ,[rc06_RT1_term_grade_letter]
                     ,[rc06_RT1_term_grade_letter_adjusted]
                     ,[rc06_RT1_term_grade_percent]
                     ,[rc06_RT1_term_grade_percent_adjusted]                     
                     ,[rc06_RT2_term_grade_letter]
                     ,[rc06_RT2_term_grade_letter_adjusted]
                     ,[rc06_RT2_term_grade_percent]
                     ,[rc06_RT2_term_grade_percent_adjusted]
                     ,[rc06_RT3_term_grade_letter]
                     ,[rc06_RT3_term_grade_letter_adjusted]
                     ,[rc06_RT3_term_grade_percent]
                     ,[rc06_RT3_term_grade_percent_adjusted]
                     ,[rc06_RT4_term_grade_letter]
                     ,[rc06_RT4_term_grade_letter_adjusted]
                     ,[rc06_RT4_term_grade_percent]
                     ,[rc06_RT4_term_grade_percent_adjusted]
                     ,[rc06_CUR_term_grade_letter_adjusted]
                     ,[rc06_CUR_term_grade_percent]
                     ,[rc06_CUR_term_grade_percent_adjusted]                     
                     ,[rc06_teacher_name]
                     ,[rc06_y1_grade_letter]
                     ,[rc06_y1_grade_percent]
                     ,[rc07_course_name]
                     ,[rc07_credit_hours]
                     ,[rc07_e1_grade_percent]
                     ,[rc07_e2_grade_percent]
                     ,[rc07_RT1_term_grade_letter]
                     ,[rc07_RT1_term_grade_letter_adjusted]
                     ,[rc07_RT1_term_grade_percent]
                     ,[rc07_RT1_term_grade_percent_adjusted]
                     ,[rc07_RT2_term_grade_letter]
                     ,[rc07_RT2_term_grade_letter_adjusted]
                     ,[rc07_RT2_term_grade_percent]
                     ,[rc07_RT2_term_grade_percent_adjusted]
                     ,[rc07_RT3_term_grade_letter]
                     ,[rc07_RT3_term_grade_letter_adjusted]
                     ,[rc07_RT3_term_grade_percent]
                     ,[rc07_RT3_term_grade_percent_adjusted]
                     ,[rc07_RT4_term_grade_letter]
                     ,[rc07_RT4_term_grade_letter_adjusted]
                     ,[rc07_RT4_term_grade_percent]
                     ,[rc07_RT4_term_grade_percent_adjusted]
                     ,[rc07_CUR_term_grade_letter_adjusted]
                     ,[rc07_CUR_term_grade_percent]
                     ,[rc07_CUR_term_grade_percent_adjusted]                     
                     ,[rc07_teacher_name]
                     ,[rc07_y1_grade_letter]
                     ,[rc07_y1_grade_percent]
                     ,[rc08_course_name]
                     ,[rc08_credit_hours]
                     ,[rc08_e1_grade_percent]
                     ,[rc08_e2_grade_percent]
                     ,[rc08_RT1_term_grade_letter]
                     ,[rc08_RT1_term_grade_letter_adjusted]
                     ,[rc08_RT1_term_grade_percent]
                     ,[rc08_RT1_term_grade_percent_adjusted]
                     ,[rc08_RT2_term_grade_letter]
                     ,[rc08_RT2_term_grade_letter_adjusted]
                     ,[rc08_RT2_term_grade_percent]
                     ,[rc08_RT2_term_grade_percent_adjusted]
                     ,[rc08_RT3_term_grade_letter]
                     ,[rc08_RT3_term_grade_letter_adjusted]
                     ,[rc08_RT3_term_grade_percent]
                     ,[rc08_RT3_term_grade_percent_adjusted]
                     ,[rc08_RT4_term_grade_letter]
                     ,[rc08_RT4_term_grade_letter_adjusted]
                     ,[rc08_RT4_term_grade_percent]
                     ,[rc08_RT4_term_grade_percent_adjusted]
                     ,[rc08_CUR_term_grade_letter_adjusted]
                     ,[rc08_CUR_term_grade_percent]
                     ,[rc08_CUR_term_grade_percent_adjusted]                     
                     ,[rc08_teacher_name]
                     ,[rc08_y1_grade_letter]
                     ,[rc08_y1_grade_percent]
                     ,[rc09_course_name]
                     ,[rc09_credit_hours]
                     ,[rc09_e1_grade_percent]
                     ,[rc09_e2_grade_percent]
                     ,[rc09_RT1_term_grade_letter]
                     ,[rc09_RT1_term_grade_letter_adjusted]
                     ,[rc09_RT1_term_grade_percent]
                     ,[rc09_RT1_term_grade_percent_adjusted]
                     ,[rc09_RT2_term_grade_letter]
                     ,[rc09_RT2_term_grade_letter_adjusted]
                     ,[rc09_RT2_term_grade_percent]
                     ,[rc09_RT2_term_grade_percent_adjusted]
                     ,[rc09_RT3_term_grade_letter]
                     ,[rc09_RT3_term_grade_letter_adjusted]
                     ,[rc09_RT3_term_grade_percent]
                     ,[rc09_RT3_term_grade_percent_adjusted]
                     ,[rc09_RT4_term_grade_letter]
                     ,[rc09_RT4_term_grade_letter_adjusted]
                     ,[rc09_RT4_term_grade_percent]
                     ,[rc09_RT4_term_grade_percent_adjusted]
                     ,[rc09_CUR_term_grade_letter_adjusted]
                     ,[rc09_CUR_term_grade_percent]
                     ,[rc09_CUR_term_grade_percent_adjusted]                     
                     ,[rc09_teacher_name]
                     ,[rc09_y1_grade_letter]
                     ,[rc09_y1_grade_percent]
                     ,[rc10_course_name]
                     ,[rc10_credit_hours]
                     ,[rc10_e1_grade_percent]
                     ,[rc10_e2_grade_percent]
                     ,[rc10_RT1_term_grade_letter]
                     ,[rc10_RT1_term_grade_letter_adjusted]
                     ,[rc10_RT1_term_grade_percent]
                     ,[rc10_RT1_term_grade_percent_adjusted]
                     ,[rc10_RT2_term_grade_letter]
                     ,[rc10_RT2_term_grade_letter_adjusted]
                     ,[rc10_RT2_term_grade_percent]
                     ,[rc10_RT2_term_grade_percent_adjusted]
                     ,[rc10_RT3_term_grade_letter]
                     ,[rc10_RT3_term_grade_letter_adjusted]
                     ,[rc10_RT3_term_grade_percent]
                     ,[rc10_RT3_term_grade_percent_adjusted]
                     ,[rc10_RT4_term_grade_letter]
                     ,[rc10_RT4_term_grade_letter_adjusted]
                     ,[rc10_RT4_term_grade_percent]
                     ,[rc10_RT4_term_grade_percent_adjusted]
                     ,[rc10_CUR_term_grade_letter_adjusted]
                     ,[rc10_CUR_term_grade_percent]
                     ,[rc10_CUR_term_grade_percent_adjusted]                     
                     ,[rc10_teacher_name]
                     ,[rc10_y1_grade_letter]
                     ,[rc10_y1_grade_percent]
                     ,[rc11_course_name]
                     ,[rc11_credit_hours]
                     ,[rc11_e1_grade_percent]
                     ,[rc11_e2_grade_percent]
                     ,[rc11_RT1_term_grade_letter]
                     ,[rc11_RT1_term_grade_letter_adjusted]
                     ,[rc11_RT1_term_grade_percent]
                     ,[rc11_RT1_term_grade_percent_adjusted]
                     ,[rc11_RT2_term_grade_letter]
                     ,[rc11_RT2_term_grade_letter_adjusted]
                     ,[rc11_RT2_term_grade_percent]
                     ,[rc11_RT2_term_grade_percent_adjusted]
                     ,[rc11_RT3_term_grade_letter]
                     ,[rc11_RT3_term_grade_letter_adjusted]
                     ,[rc11_RT3_term_grade_percent]
                     ,[rc11_RT3_term_grade_percent_adjusted]
                     ,[rc11_RT4_term_grade_letter]
                     ,[rc11_RT4_term_grade_letter_adjusted]
                     ,[rc11_RT4_term_grade_percent]
                     ,[rc11_RT4_term_grade_percent_adjusted]
                     ,[rc11_CUR_term_grade_letter_adjusted]
                     ,[rc11_CUR_term_grade_percent]
                     ,[rc11_CUR_term_grade_percent_adjusted]                     
                     ,[rc11_teacher_name]
                     ,[rc11_y1_grade_letter]
                     ,[rc11_y1_grade_percent]
                     ,[rc12_course_name]
                     ,[rc12_credit_hours]
                     ,[rc12_e1_grade_percent]
                     ,[rc12_e2_grade_percent]
                     ,[rc12_RT1_term_grade_letter]
                     ,[rc12_RT1_term_grade_letter_adjusted]
                     ,[rc12_RT1_term_grade_percent]
                     ,[rc12_RT1_term_grade_percent_adjusted]
                     ,[rc12_RT2_term_grade_letter]
                     ,[rc12_RT2_term_grade_letter_adjusted]
                     ,[rc12_RT2_term_grade_percent]
                     ,[rc12_RT2_term_grade_percent_adjusted]
                     ,[rc12_RT3_term_grade_letter]
                     ,[rc12_RT3_term_grade_letter_adjusted]
                     ,[rc12_RT3_term_grade_percent]
                     ,[rc12_RT3_term_grade_percent_adjusted]
                     ,[rc12_RT4_term_grade_letter]
                     ,[rc12_RT4_term_grade_letter_adjusted]
                     ,[rc12_RT4_term_grade_percent]
                     ,[rc12_RT4_term_grade_percent_adjusted]
                     ,[rc12_CUR_term_grade_letter_adjusted]
                     ,[rc12_CUR_term_grade_percent]
                     ,[rc12_CUR_term_grade_percent_adjusted]                     
                     ,[rc12_teacher_name]
                     ,[rc12_y1_grade_letter]
                     ,[rc12_y1_grade_percent])
 ) p